import pandas as pd
import pickle
import numpy as np
import math
from itertools import groupby

train_path = r'security_train.csv'
test_path = r'security_test.csv'

mylog = lambda x: math.floor(math.log(x,1.6))+1

def repeated_substring(s):
    n = len(s)
    for i in range(2, n):
        if n % i == 0:
            k = n // i
            for j in range(i):
                if s[j::i] != s[j:j+k:i]:
                    break
            else:
                return True
    return False


def repeat_elements(lst, k):
    # 将列表中所有连续k个元素重复n次的部分转换为重复mylog(n)次
    result = []
    i = 0
    while i < len(lst):
        if lst[i:i+k] == lst[i+k:i+k+k] :
            j = i + k
            while j < len(lst) and lst[j:j+k] == lst[j+k:j+k+k]:
                j += k
            j += k
            n = (j - i) // k
            if not repeated_substring(lst[i:i+k]):
                n = mylog(n)
            for _ in range(n):
                result.extend(lst[i:i+k])
            i = j
        else:
            result.append(lst[i])
            i += 1
    return result

def diff_repeat_elements(lst, k):
    # 将列表中所有小于k个元素重复n次的部分转换为重复mylog(n)次
    result=lst.copy()
    for i in range(1,k):
        if 2 * i > len(result):
            break
        result = repeat_elements(result, i)
    return result


def read_train_file(path):
    labels = []
    files = []
    data = pd.read_csv(path)
    # for data in data1:
    goup_fileid = data.groupby('file_id')
    for file_name, file_group in goup_fileid:
        print(file_name)
        tid_group = file_group.groupby('tid')
        tid_ls = []
        for tid_name, tgroup in tid_group:
            result = tgroup.sort_values(['index'], ascending=True)
            a_tid_ls = result['api'].tolist()
            a_tid_ls = diff_repeat_elements(a_tid_ls,30)
            tid_ls.append(a_tid_ls)
        files.append(tid_ls)
        file_labels = file_group['label'].values[0]
        labels.append(file_labels)
    files=files
    with open("files.pkl", 'wb') as f:
        pickle.dump(labels, f)
        pickle.dump(files, f)    
    print(len(labels))
    print(len(files))



def read_test_file(path):
    files = []
    data = pd.read_csv(path)
    # for data in data1:
    goup_fileid = data.groupby('file_id')
    for file_name, file_group in goup_fileid:
        print(file_name)
        tid_group = file_group.groupby('tid')
        tid_ls = []
        for tid_name, tgroup in tid_group:
            result = tgroup.sort_values(['index'], ascending=True)
            a_tid_ls = result['api'].tolist()
            a_tid_ls = diff_repeat_elements(a_tid_ls,30)
            tid_ls.append(a_tid_ls)
        files.append(tid_ls)
    files=files
    with open("test_files.pkl", 'wb') as f:
        pickle.dump(files, f)    
    print(len(files))


if __name__ == '__main__':
    # print("read train file.....")
    # read_train_file(train_path)

    print("read test file......")
    read_test_file(test_path)
